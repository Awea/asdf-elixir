#!/usr/bin/env bash

releases_path="https://repo.hex.pm/builds/elixir/builds.txt"
cmd="curl -s $releases_path"

# Sort the list of versions.
#
# Does not expect any arguments, assumes the list of versions is provided in
# STDIN.
#
sort_versions() {
  # Sort versions by the numerical values of each field.
  #
  # By default, sort will consider the entire line and sort lines
  # alphabetically according to the current system locale, which influences
  # details like whether downcase letters come before the uppercase ones.
  #
  # First, you'll notice the environment variable `LC_ALL` is being set to
  # `C` for this command. This enables bytewise sorting, which means
  # characters will be sorted by their numerical representation in the
  # encoding table (think ASCII for US English). This makes the sorting
  # algorithm completely uniform since it disregards the user's system
  # locale.
  #
  # Then you'll notice the `-t.` option, which changes the command to split
  # lines on the provided separator `.`, instead of considering the whole
  # line, which will influence the next options.
  #
  # Finally you'll notice the `k` options, which are key definitions that
  # tell sort how we want the sorting algorithm to look at lines. Each key
  # definition will be taken into consideration in order when deciding the
  # position of a line.
  #
  # Each key definition has the following format:
  # * First it specifies the number of the field where this definition
  #   starts, according to the separation specified by `-t`.
  # * Then it specified the number of the field where this definition stops.
  #   When you want to consider a single field, both start and stop values
  #   are the same in the definition.
  # * Finally, the definitions include a single-letter ordering option, which
  #   will override the global ordering options for the current key. In this
  #   case, we use `n` to ensure the sorting is numerical.
  #
  LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n
}

# Fetch all built versions,
# get only first column,
# remove all major.minor versions leaving only major.minor.patch versions,
# remove the v prefix, eg v1.0.0 -> 1.0.0
# sort the versions
versions=$(eval $cmd | cut -d\  -f1 | awk -F'.' 'NF!=2' | sed 's/v//;s/\",//' | sort_versions)
echo $versions
